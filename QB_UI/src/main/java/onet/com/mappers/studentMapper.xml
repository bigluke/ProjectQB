<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="onet.com.student.dao.StudentDao">

<!-- 10.19 현이 학생 답안지 제출 시작 -->
<insert id="examAnswerInsert" parameterType="onet.com.vo.Student_answerDto">
	insert into student_answer(member_id, exam_info_num, question_num, exam_question_seq, student_answer_choice, student_answer_status)
	values(#{member_id}, #{exam_info_num}, #{question_num}, #{exam_question_seq}, #{student_answer_choice}, #{student_answer_status})
</insert>

<select id="searchAnswer" parameterType="int" resultType="String">
	select question_answer from question where question_num = #{question_num}
</select>

<insert id="score_chartInsert">
	insert into score_chart (member_id, exam_info_num, score_chart_score, score_chart_rank, class_name)
	values (#{param1}, #{param2}, 
	(
		select 
		IFNULL(sum(exam_question_score), 0)
		from exam_question
		where 
		question_num in 
		(select question_num from student_answer 
			where student_answer_status = 1 
			and member_id = #{param1}
			and exam_info_num = #{param2}
		)
		and exam_paper_num = (select exam_paper_num from exam_info where exam_info_num = #{param2})
	),
	0, 
	(select class_name from member where member_id = #{param1})); 
</insert>

<select id="selectRank" parameterType="int" resultType="onet.com.vo.Score_chartDto">
	select member_id, score_chart_score, rank() over(order by score_chart_score desc) as score_chart_rank 
	from score_chart
	where exam_info_num = #{exam_info_num}
	order by score_chart_score desc;
</select>

<update id="updateRank">
	update score_chart
	set score_chart_rank = 
		case 
		<foreach item="item" collection="param1" separator=" ">
			 	when member_id = #{item.member_id} then #{item.score_chart_rank}
		</foreach>
		end 
	where exam_info_num = #{param2};
</update>

<select id="countClassChart" parameterType="int" resultType="int">
	select count(*) 
	from class_chart
	where exam_info_num = #{exam_info_num}
</select>

<insert id="class_chartInsert">
	insert into class_chart (class_name, exam_info_num, class_chart_avg)
	values(
	(select class_name from member where member_id=#{param1}), 
	#{param2}, 
	(select avg(score_chart_score) 
	from score_chart
	group by exam_info_num
	having exam_info_num = #{param2})
	);
</insert>

<update id="class_chartUpdate">
	update class_chart 
	set 
	class_name = (select class_name from member where member_id=#{param1}), 
	exam_info_num = #{param2}, 
	class_chart_avg = 	(select avg(score_chart_score) 
						from score_chart
						group by exam_info_num
						having exam_info_num = #{param2})
	where exam_info_num = #{param2};
</update>

<select id="selectQuestion" parameterType="int" resultType="int">
	select question_num 
	from exam_question 
	where exam_paper_num = 
		(select exam_paper_num 
		from exam_info 
		where exam_info_num = #{param1});
</select>

<update id="updateCorrectRatio" parameterType="int">
	update question
	set question_correct_ratio = 
	(
		(select count(*) 
		from student_answer
		where question_num = #{param1}
		and student_answer_status = 1)
	/ 
		(select count(*) 
		from student_answer 
		where question_num = #{param1})
	) 
	* 100
	where question_num = #{param1};
</update>
<!-- 10.19 현이 학생 답안지 제출 끝 -->

<!-- 10.23 현이 학생 지난 시험 보기 시작 -->
<select id="searchPastExam" parameterType="String" resultType="onet.com.vo.ExamInfoDto">
	select * from exam_info
	where exam_info_num in (select distinct exam_info_num from student_answer where member_id=#{param1})
</select>

<select id="searchStudentName" parameterType="String" resultType="String">
	select member_name from member
	where member_id = #{param1}
</select>

<select id="searchPastExamKeyword" resultType="onet.com.vo.ExamInfoDto">
	select * from exam_info
	where (exam_info_num in (select distinct exam_info_num from student_answer where member_id=#{param1}))
	and (exam_info_name like concat('%', #{param2}, '%') || exam_info_desc like concat('%', #{param2}, '%'))
</select>	
<!-- 10.23 현이 학생 지난 시험 보기 끝 -->

<!-- 10.24 현이 학생 지난 시험지 보기 시작 -->

<select id="examPaperDoQuestion" resultType="onet.com.vo.ExamPaperDoQuestionDto"><!-- 문제 정보 가져오기 -->
	select q.question_num, q.question_type, q.question_name, q.question_img, q.question_answer, 
	eq.exam_question_seq, eq.exam_question_score 
	from question q join exam_question eq
	on (q.question_num = eq.question_num)
	where eq.exam_paper_num = 
	(select exam_paper_num from exam_info where exam_info_num = #{exam_info_num})
	order by eq.exam_question_seq
	<if test="begin != 0 or rowPerPage != 0">
		limit #{begin}, #{rowPerPage}
	</if>
</select>	

<select id="examPaperDoQuestion_choice" parameterType="int" resultType="onet.com.vo.Question_choiceDto"><!-- 문제 보기 가져오기 -->
	select question_num, question_choice_num, question_choice_content, question_choice_image 
	from question_choice
	where question_num in 	
	(select q.question_num
	from question q join exam_question eq
	on (q.question_num = eq.question_num)
	where eq.exam_paper_num = 
	(select exam_paper_num from exam_info 
	where exam_info_num = #{exam_info_num})
	)
	order by question_num, question_choice_num
</select>




<select id="selectStudentAnswer" resultType="onet.com.vo.Student_answerQuesDto">
	select * 
	from student_answer a join question q
	on a.question_num = q.question_num
	where a.member_id = #{param1}
	and a.exam_info_num = #{param2}
</select>

<select id="selectStudentWrongAnswer" resultType="onet.com.vo.Student_answerQuesDto">
	select * 
	from student_answer a join question q
	on a.question_num = q.question_num
	where a.member_id = #{param1}
	and a.exam_info_num = #{param2}
	and a.student_answer_status = 0
</select>

<select id="examPaperDoWrongQuestion" resultType="onet.com.vo.ExamPaperDoQuestionDto">
	select q.question_num, q.question_type, q.question_name, q.question_img, q.question_answer, 
	eq.exam_question_seq, eq.exam_question_score
	from question q join exam_question eq
	on (q.question_num = eq.question_num)
	where 
	eq.exam_paper_num = (select exam_paper_num from exam_info where exam_info_num = #{exam_info_num}) 
	and q.question_num in (select question_num from student_answer where exam_info_num = #{exam_info_num} and member_id = #{member_id} and student_answer_status = 0)
	order by eq.exam_question_seq
	<if test="begin != 0 or rowPerPage != 0">
		limit #{begin}, #{rowPerPage}
	</if>
</select>

<select id="examPaperDoWrongQuestion_choice" parameterType="int" resultType="onet.com.vo.Question_choiceDto"><!-- 문제 보기 가져오기 -->
	select question_num, question_choice_num, question_choice_content, question_choice_image 
	from question_choice
	where question_num in 	
	(select q.question_num
	from question q join exam_question eq
	on (q.question_num = eq.question_num)
	where eq.exam_paper_num = 
	(select exam_paper_num from exam_info 
	where exam_info_num = #{param1})
	)
	order by question_num, question_choice_num
</select>
<!-- 10.24 현이 학생 지난 시험지 보기 끝 -->

<!-- 10.29민지 학생이쪽지보내기 -->
<insert id="sendTeacherMessage" parameterType="onet.com.vo.MessageDto" >
insert into message (send_member_id,receive_member_id,message_content)
	values(#{send_member_id}, #{receive_member_id}, #{message_content})
</insert>

<select id="wrongQuestionCount" resultType="int"><!-- 한 시험지에 담긴 문제의 개수 -->
	select count(question_num)
	from student_answer
	where exam_info_num = #{param2}
	and member_id = #{param1}
	and student_answer_status = 0
</select>


<!-- 10.29 재훈 학생 자기 등수 확인 시작 -->
<select id="myRank" parameterType="String" resultType="onet.com.vo.Score_chartDto">

select * from score_chart s join member m on (s.member_id = m.member_id) where m.member_name = #{param1} and s.exam_info_num = #{param2}

</select>

<!-- 10.29 재훈 학생 자기 등수 확인 시작 -->



</mapper>